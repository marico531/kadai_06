<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ“ãƒ‡ã‚ªè¨ºå¯Ÿã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
   <div class="container">
        <!-- ãƒ“ãƒ‡ã‚ªé›»è©±éƒ¨åˆ† -->
        <div class="left-side">
            <h1>ğŸ¥Doctorã¨ãƒ“ãƒ‡ã‚ªãƒãƒ£ãƒƒãƒˆğŸ¥</h1>
        <!-- ä»¥ä¸‹ãŒãƒ“ãƒ‡ã‚ªç”¨ã®ã‚³ãƒ¼ãƒ‰ -->
        <div class="grid-container">
            <div id="local" class="item">
             <video id="local-video" autoplay playsinline></video>
             <audio id="local-audio" autoplay muted controls></audio>
             <p class="id-text">ID: <span id="my-id"></span></p>
             <button id="join-button" class="item" label="button">Roomä½œæˆ/å‚åŠ </button>
             <input id="room-name" placeholder="Roomå"></input>
             <button id="local-mute-buton" class="item" label="button" disabled>æ˜ åƒãƒ»éŸ³å£°OFF</button>
             <button id="leave-button" class="item" label="button"ã€€disabled>Roomé–‰ã˜ã‚‹</button>
           </div>
           <div id="remote" class="item">
             <video id="remote-video" autoplay playsinline></video>
             <audio id="remote-audio" autoplay controls></audio>
             <p class="id-text">ID: <span id="remote-id"></span></p>
             <div id="button-area"></div>
           </div>
         </div>
        <!-- ä»¥ä¸ŠãŒãƒ“ãƒ‡ã‚ªç”¨ã®ã‚³ãƒ¼ãƒ‰ -->
       
        </div>

        <div class="right-side">
            <div id="subtitles" class="subtitles-box">
                <!-- å­—å¹•ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
            <div id="subtitle-buttons" class="subtitle-buttons">
                <button id="hide-subtitles">å­—å¹•éè¡¨ç¤º</button>
                <button id="show-subtitles">å­—å¹•è¡¨ç¤º</button>
                <button id="clear-subtitles">å­—å¹•å‰Šé™¤</button> <!-- å­—å¹•å‰Šé™¤ãƒœã‚¿ãƒ³ -->
            </div>

            <div id="question-box" class="input-box">
                <input type="text" id="question-input" placeholder="è³ªå•ã‚’å…¥åŠ›">
                <button id="send-question">é€ä¿¡</button>
                <button id="delete-answer">å›ç­”å‰Šé™¤</button> <!-- å›ç­”å‰Šé™¤ãƒœã‚¿ãƒ³ -->
            </div>

            <div id="response" class="response-box">
                <!-- AIã®å›ç­”ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        
        </div>

    </div>
    <!-- jQueryã®èª­ã¿è¾¼ã¿ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


    <!-- SkyWayã®SDKã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room/dist/skyway_room-latest.js"></script> 
    <!-- SkyWayã®JSã®èª­ã¿è¾¼ã¿ -->
    <script src="skyway2.js"></script>
    <!-- jsã®èª­ã¿è¾¼ã¿ -->  

    <!-- Firebase App (firebase-app.js) ã®èª­ã¿è¾¼ã¿ -->
    <script type="module">
    
    // Firebase SDKã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded } 
        from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js"; /*è¿½åŠ ãŒå¿…è¦*/
     // TODO: Add SDKs for Firebase products that you want to use
     // https://firebase.google.com/docs/web/setup#available-libraries

    
    const firebaseConfig = {
    apiKey: ":::::::::::::::",
    authDoÃ¥main: ":::::::::::::::::",
    databaseURL: "::::::::::::::::::::::",
    projectId: ":::::::::::::",
    storageBucket: "::::::::::::::::",
    messagingSenderId: ":::::::::::::::",
    appId: "::::::::::::::::::"
  };

    // Firebaseã®åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const questionsRef = ref(db, 'questions');

    //   Web Speech APIã‚’ä½¿ç”¨ã—ã¦éŸ³å£°ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
      function startSpeechRecognition() {
            const recognition = new webkitSpeechRecognition() || new SpeechRecognition();
            recognition.lang = 'ja-JP'; // è¨€èªã‚’æ—¥æœ¬èªã«è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ï¼‰
            recognition.continuous = true; // é€£ç¶šã—ã¦éŸ³å£°ã‚’èªè­˜
            recognition.interimResults = false; // æš«å®šçµæœã‚’è¡¨ç¤ºã—ãªã„

            recognition.onresult = function(event) {
                const lastResultIndex = event.results.length - 1;
                const transcript = event.results[lastResultIndex][0].transcript.trim();
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
                push(questionsRef, {
                    question: 'éŸ³å£°',
                    answer: transcript,
                    timestamp: new Date().toISOString()
                });
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
            };

            recognition.onend = function() {
                console.log('Speech recognition ended');
                recognition.start(); // è‡ªå‹•çš„ã«å†ã‚¹ã‚¿ãƒ¼ãƒˆ
            };

            recognition.start();
        };

    $(document).ready(function() {
        // å­—å¹•ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºæ©Ÿèƒ½
        $('#hide-subtitles').click(function() {
            $('#subtitles').hide();
        });
    
        $('#show-subtitles').click(function() {
            $('#subtitles').show();
        });
    
        // å­—å¹•ã‚’å…¨ã¦å‰Šé™¤ã™ã‚‹æ©Ÿèƒ½
        $('#clear-subtitles').click(function() {
            $('#subtitles').empty();
        });
    
        // å›ç­”ã‚’å‰Šé™¤ã™ã‚‹æ©Ÿèƒ½
        $('#delete-answer').click(function() {
            $('#response').empty();
        });
    
        // è³ªå•ã‚’é€ä¿¡ã™ã‚‹
        $('#send-question').click(async function() {
            const question = $('#question-input').val().trim();
            if (question) {
                $('#response').text('AIãŒå›ç­”ã‚’ç”Ÿæˆä¸­ã§ã™...');
    
                // ChatGPT APIã‚’ä½¿ç”¨ã—ã¦å›ç­”ã‚’å–å¾—
                const aiResponse = await getAIResponse(question);
    
                // å›ç­”æ¬„ã«ã®ã¿è³ªå•ã¨å›ç­”ã‚’è¡¨ç¤º
                $('#response').html('<div><strong>è³ªå•:</strong> ' + escapeHtml(question) + '<br><strong>å›ç­”:</strong> ' + escapeHtml(aiResponse) + '</div>');
    
                // Firebaseã«è³ªå•ã¨å›ç­”ã‚’ä¿å­˜
                push(questionsRef, { question: question, answer: aiResponse });
                
                // è³ªå•å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
                $('#question-input').val('');
            }
        });
    
        // Enterã‚­ãƒ¼ã§é€ä¿¡
        $('#question-input').keypress(function(e) {
            if (e.which === 13) { // Enterã‚­ãƒ¼
                $('#send-question').click();
            }
        });
    
             // å›ç­”å‰Šé™¤ãƒœã‚¿ãƒ³
            $('#delete-response').click(function() {
            $('#response').text(''); // å›ç­”ã‚’å‰Šé™¤
            });

            // å­—å¹•éè¡¨ç¤ºãƒœã‚¿ãƒ³
            $('#hide-subtitles').click(function() {
            $('#subtitles').hide();
            });

            // å­—å¹•è¡¨ç¤ºãƒœã‚¿ãƒ³
            $('#show-subtitles').click(function() {
            $('#subtitles').show();
            });

            // AIã®å¿œç­”ã‚’å–å¾—ã™ã‚‹é–¢æ•°
            async function getAIResponse(question) {
                const apiKey = '::::::::::::::::::::::'; // OpenAIã®APIã‚­ãƒ¼ã‚’è¨­å®š
                const apiUrl = 'https://api.openai.com/v1/chat/completions';

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4',
                            messages: [{ role: 'user', content: question }]
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        return data.choices[0].message.content.trim();
                    } else {
                        console.error('Error:', data);
                        return 'AIã‹ã‚‰ã®å›ç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
                    }
                } catch (error) {
                    console.error('Fetch Error:', error);
                    return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                }
            }

            // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ï¼ˆXSSå¯¾ç­–ï¼‰
            function escapeHtml(text) {
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        });

</script>
  
</body>
</html>
